#summary I2C implementation in PropFORTH.

= Introduction =

I2C is a communication bus.  I2C uses two wires (TxD, RxD) for communication between the microcontroller and the device.  Actually there are four wires, two for communication, and two more, one for power (3.3volts for the prop) and ground. 

The Prop EEprom uses I2C communications. 
The I2C driver support was originally developed in the context of the EEprom.
The I2C words have eeprom names. We might re-factor the th I2C layer out of the eeprom words for clarity;
Then again we might just leave it if nobody cares. 
The consequence of leaving it is that the I2C must be explained to each new user.
The consequence of refactorying the I2C out is that is potentially confuses folks that are used to it. However, the refactoring should not affect anything that uses eeprom. It would take a couple more byte in dictionary space.

= flow diagrams =

I am accustomed to using what we called "Call Flow Diagram" at the telecom jobs. 
This can exactly define the mesaging sequence for communications.

The device on the left sends the listed message to the device on the right. 

The device on the right responds to the last message with the reply listed.

We list it as ONE message per line.

Messages are listed in SEQUENCE first message at the top, last message at the bottom. 

Any transaction between the device can be described using a flow diagram (otherwise there might be some problem). 

= tokens used =

Master I2C Start (I2C-Start) and Slave Acknowledge (Sack) are defined in the I2C materials if you are curious, but the low level definitions are not needed here as they are already implemented for us in the existing kernel.  This is just to explain whats happening. 

In the flow diagram below the side with the colon sends the token, and the arrow => or <= points from the sender to the receiver.

= I2C Protocol =

I2C sequence is:

|| I2C ||

|| *Master* || _command_ || direction  || _response_ ||    *Slave* || 
|| Master:|| I2C-start|| =>  ||     ||  Slave|| 
|| Master:|| slaveAddr|| =>  ||     ||  Slave|| 
|| Master ||          ||  <= || Sack|| :Slave|| 
|| Master:|| regAddr  || =>  ||     ||  Slave|| 
|| Master ||          ||  <= || Sack|| :Slave|| 
|| Master:|| regData  || =>  ||     ||  Slave|| 
|| Master ||          ||  <= || Sack|| :Slave|| 

and the above contines until the master sends Nack (no more acknowledge)

|| Master:|| I2C-stop  ||     =>  ||     ||  Slave|| 

At this point the slave stops talking after the seeing the NACK token from the master.

The abbreviations above are defined as:
             
 * Master = Microcontroller (P8X32A)
 * Slave = EEPROM, BMP085, etc
 * I2C-Start = a specific set of pulses and timing the master sends which tell the slave device to get ready to act
 * slaveAddr:  the built-in I2C bus address number for the part we want to talk to
 * Sack = Slave Acknowledge token - a specific set of pulses and timing the slave sends back to the master to say "ok, I got it!"
 * I2C-Stop = - a specific set of pulses and timing the master sends to the slave to say "ok, we're cone for now"


 = Hardware: Wires = 

The four wires are:
 * Vdd (3.3volts, power)
 * Ground 
 * TxD
 * RxD

TxD and RxD are transmit and receive. 

= I2C in PropFORTH =

I2C is implemented in the kernel to talk to the AT24C512 EEPROM built in to every prop system. 

The I2C words are 

`eestart`
'eestop'
'eeread'
'eewrite'


= Details =

Add your content here.  Format your content with:
  * Text in *bold* or _italic_
  * Headings, paragraphs, and lists
  * Automatic links to other wiki pages