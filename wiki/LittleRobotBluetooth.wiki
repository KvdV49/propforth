#summary HC05 and HC06 Bluetooth for Little Robot(tm)
#labels HC06,LittleRobot,bluetooth,v5.5

<wiki:toc max_depth="9" />

= Introduction =

The HC05 and HC06  Bluetooth module allows communication with the prop via bluetooth.  No cables are needed after initial programming. 

This pages covers the immediate set up steps for the HC06.  If you have problems, or want to use the hc05, see

http://code.google.com/p/propforth/wiki/LittleRobotBluetoothDETAILS

for addditional details.

= HC06 =

The workshop is using the HC06 modules mounted on a 4 or 6 pin carrier board.  only Vcc (3.3v), GND, Rxd and Txd are used.

== Hardware connections ==

Connect Vcc to 3.3volts.  This is different from all the other parts, the connection is for HC06 Vcc goes to 3.3 on the quickstart. 

Connect GND to Vss as normal.

Connect HC06 - Tx tp pin 26

Connect HC06 - Rx tp pin 27

If you have a 6 pin HC06, there are two more pins that are not connected.  These are only used initialization and troubleshooting. Don't worry about connecting KEY to P1.  We only do this if the HC06 is stubborn.

==  Power On ==

When you apply power, the STATUS LED on the HC06 should blink.  This means the HC06 is ready.

If the HC06 STATUS LED does NOT blink, pull the power wire for a second or two, and reconnect.  Sometimes they come up flashing every time, sometimes they only come up every other time.  This is fine for our situation. 

== Configuration Scripts ==

The following is a modification of the script found in bot.f and QSbot.f.  Feel free to modify these script once you are comfortable with their action. 

The HC06 need to be configured rather than left as default.  The names need to to be unique and the baud needs to be set from 9600 to 230400.  This is typically done before the session; each manufacturer tends to set something just a little "off" from normal. This instuction assume pre-configured modules with unique names and 230400 baud. 

Full Instructions for configuring the HC06 can be found on this wiki, use at your own discretion. 

= Pair with an Bluetooth master device =

To pair with an Android or windows device:

 * the red LED must be blinking 
 * Scan for the HC06 using an android device pairing screen.  The new name should be displayed. 
 * Pair with the device.  It should be listed as PAIRED DEVICE.  The red LED will continue to blink (until you CONNECT via blueterm)

= Connect to the HC06 =

From your terminal program:
 * Tera term on windows over bluetooth
 * blueterm terminal emulation app on Android
 * GREEN termninal emulation and touch interface app on android

Find Connect Device.  Select the HC06, it will display the name you set. The RED LED on the HC06 will flash, and stay on solid when the divice is connected. 

The terminal will not respond yet, we have to set up the auto boot.f scrip still. 

= Auto BOOT.F for HC06 testing =

Use the following autoboot script to check the bluetooth setup.

This is a trimmed version of the auto boot.f script.  It just switches the prop serial I/O pins to use the HC06 pins (26 & 27)

After power cycle or reboot, the prop serial  I/O pins will switch to the bluetooth pins.  You can connect via blueterm or GREEN.

REMEMBER:  YOU MUST copy this to your editor, and paste it from there.  It doesn't work it you copy from the browser and paste directly to the terminal.

{{{
fl

fswrite BTtest.f

\ green wire - this is not used on the carrier mounted modules
\ 1 wconstant hcProgPin 

\ white/orange wire - QSbot RXD to p27
27 wconstant hcRx

\ white/green wire - QSbot TXD to p26
26 wconstant hcTx

\  initally they come up at 9600,  switch this after we set it to 230400
\ 9600 4/ wconstant hcBaud
\ 230400 4/ wconstant hcBaud 
\ 0 wconstant hcSerialCog
\ hcSerialCog cogreset 100 delms
\ c" hcRx hcTx hcBaud serial" hcSerialCog cogx 100 delms
\ : hcSend cogid hcSerialCog iolink .cstr 1000 delms cogid iounlink cr ;

: onreset6
  fkey? and fkey? and or h1B <>
if
     $S_con iodis $S_con cogreset 100 delms
     c" hcRx hcTx 57600 serial" $S_con cogx 100 delms
     cogid >con
then
     c" onreset6" (forget)
;

...

fswrite boot.f

hA state orC! version W@ .cstr cr cr cr
: findEETOP
0
h100000 h8000
do
i t0 2 eereadpage
if
leave
else
i h7FFE + t0 3 eereadpage
if
leave
else
drop i h8000 +
then
then
h8000 +loop
;

c" boot.f - Finding top of eeprom, " .cstr findEETOP ' fstop 2+ alignl L! forget findEETOP c" Top of eeprom at: " .cstr fstop . cr
c" boot.f - Loading BTtest.f~h0D~h0D" .cstr hA state andnC!
fsload BTtest.f
c" boot.f - Loaded BTtest.f~h0D~h0D" .cstr hA state andnC!
c" boot.f - DONE PropForth Loaded~h0D~h0D" .cstr hA state andnC!

...



cr

}}}

== Verify the Bluetooth connection ==

After reboot or power cycle, the prop will switch the serial connection to the blue tooth I/O pins.

The terminal program on a connected device will dispay the regular propforth prompt. 

Type a propforth command like 'words' to show the connection is working. 

= Proceed to the final QSbot.f program =

Leave the above programs BTtest.f aand boot.f in the eeprom memory.

Use the file systems list function 
{{{
fsls 
}}}

to display that the files are present.  

The BTtest is loaded by boot.f or other diagnostics as needed.  

The boot.f file is superceded by the next boot.f later on, so fine left as it is.  

Remembe, you can drop the last file in the list ussing the fsdrop command
{{{
fsdrop
}}}

Or you can remove all the files at once using the fsclear command.

{{{
fsclear
}}}

Be aware that you need to reload all the drivers in order after fsclear. 






-----

= TROUBLE SHOOTING =

The HC06 RED LED MUST BE BLINKING to program the HC06 via the PC terminal scripts.  Disconnect and reconnect the HC06 Vcc to put the HC06 into blink mode

The HC06 RED LED MUST BE BLINKING to pair with the bluetooth device terminal program.  Disconnect and reconnect the HC06 Vcc to put the HC06 into blink mode

The HC06 RED LED MUST BE BLINKING to connect to the bluetooth device terminal program.  Disconnect and reconnect the HC06 Vcc to put the HC06 into blink mode

After the HC06 is PAIRED with your android device, the RED LED will continue to blinky

After the HC06 is connected to the android terminal program , the RED LED will stay lit continuously

If the auto boot.f command gives you trouble, press and hold the ESC key during boot.  This will skip the auto boot.f behavior.

To remove a bad copy of the boot.f script:

 * from the propforth command line:
 * type 'fsls' to list the current script files
 * type 'fsclear'  to remove the script name entry

To put in a fixed/modified script:

 * reload the script (copy and paste from your editor)
 * reboot

= NOTES =

== Data Sheet ==

There are several data sheets available.  They are all pretty much bad translations of the pretty bad chineese original. 

http://etang.co.uk/datasheet/hc06/Bluetooth_HC-06_datasheet%20by%20cn.pdf

http://www.wavesen.com/mysys/db_picture/news3/200951285105101.pdf

- end -