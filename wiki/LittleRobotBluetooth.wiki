#summary HC05 and HC06 Bluetooth for Little Robot(tm)
#labels v5.3,LittleRobot,bluetooth,v5.5

<wiki:toc max_depth="9" />

= Introduction =

The HC05 and HC06  Bluetooth module allows communication with the prop via bluetooth.  No cables are needed after initial programming. 

The HC05/HC06 do not have "PINS" per se.  It has teeny micro notches or scallops that are much closer together than the standard .1 inch spacing I usually work with.  But, you can solder a bit of wire to the notch, and make a connection to the prop. 

You can put a pin on the other end of the wire, and jab it right into the bread board or 40 pin female connector on a Quickstart board.

It is advisable to mount the soldered board, so the solder joints don't break; these are really hard to fix once they rip the solder pad off the scallop. 

You can use any color wire you want, if you use the same color as we do yours will match the pictures. :)

This source code is also included in the propforth download archive beginning with release v 5.3

== HC05 KEY is Scallop 34 ==

Connect:

|| HC05 Bluetooth module ||
|| HC05  || Prop || Wire Color||
||Pin 1 - TX  || P27 || Grey  ||
||Pin 2 - RX   || P26 || white||
||Pin 12 - 3.3v ||3.3v || Orange||
||Pin 13 - GND  || GND || Blue||
||Pin 34 - Key || P22  || Green||


== HC06 KEY is Scallop 26 ==

Connect:

|| HC06 Bluetooth module ||
|| HC06  || Prop || Wire Color||
||Pin 1 - TX  || P27 || Grey  ||
||Pin 2 - RX   || P26 || white||
||Pin 12 - 3.3v ||3.3v || Orange||
||Pin 13 - GND  || GND || Blue||
||Pin 26 - Key || P22  || Green||


NOTICE that for this Little Robot instruction page, I changed the pin assignment from Sal's instructions.  The instruction Sal made for the download archive are for his Gadget Gangster board, these below are for the Quickstart.  You could use either for either, I find these pins are easier on the quickstart.

= Set up HC05 =

Following the above, we have HC05 serial connected to Prop pins P26 & P27. (which are Quickstart connector locations 27 and 28). 

HC05 comes with 9600 baud by default.  We run a configuration script that talks on P26 & P27 to the HC05

It tells the HC05 to set its name (to whatever you want, I don't know many max  characters)

It also sets the HC05 to 230400 baud.  So the Config script  (at 9600) won't communicate a second time; to rerun the script you have to edit and set the right baud. 

Last thing will be to change the PropForth Kerrnel to talk on P27 & P28, instead of P30 and P31. 

NOTE: If something goes really wrong, you can flash the Quickstart back to a standard (P30 and P31) kernel at any time.   This puts you back to talking on the USB cable, plug it in and fix whatever.  After its fixed, reflash to the P276 & P27 kernel.

FYI:  Propforth runs are 230400 by default, on pins 30 and 31

== Inital Configuration of the HC05 ==

Run the 9600 baud script to program the factory fresh HC05

We run this script to 
 * give it a unique name (choose anything)
 * set baud to 230400
 * set (this one) to SLAVE mode
 * set the password (each kid connects to the correct bot)

I set the unique name to LittleRobotYYYMMDDhhmm

This way, each kid, in each class, gets a unique number.  When I meet with the robots again, I can somtimes tell when the bot came into service.
 
NOTICE that after the script run successfully, the baud rate has been set from 9600 to 230400.  So the script won't run a second time.  If you with to re-run the script (and name your bot "JimmyJohinson") you must change the comments so the script is set to 230400 like the HC05.

Later we can use this same script to add another bluetooth as MASTER, and make the bots talk over bluetooth, but that is a future exercise.

== Paste the HC05 configuration script into the Terminal ==

First edit the script to set
 * The robot ID
 * the Robot password pin

{{{

\ REMEMBER set pins in PROPFORTH as below!!!! 
\ Im USING quickstart

fl

\\ for the HC05

\ REMEMBER! ONLY connect the KEY-GREEN-Prop P22 wire when you run the programming script!
\ AFTER the script is run, disconnect the green wire!
\ green wire \ GREEN key - PROGRAM WHEN 3.3V - to prop 22 | Quickstart postion23
\ Raise P22 Hi when connected to HCo5-pin34 to program
  22 wconstant hcProgPin 

\ after programming, disconnect the GREEN wire!

\ white/orange wire    \ WHITE - HC05-pin02 Rx - to prop 26 | QuickStart position27
  26 wconstant hcRx

\ white/green wire     \ GREY - HC05-pin01 Tx - to prop 27 | Quickstart position28
  27 wconstant hcTx

 9600 4/ wconstant hcBaud       \ REMEMBER! AFTER you run this once,
\ the baud is set to a really fast speed, so you must change these comments
\ 230400 4/ wconstant hcBaud  

0 wconstant hcSerialCog \ cog0 will talk to the HC05 for programming

hcSerialCog cogreset 100 delms
c" hcRx hcTx hcBaud serial" hcSerialCog cogx 100 delms
1 hcSerialCog sersetflags


: hcSend
	cogid hcSerialCog iolink .cstr 1000 delms cogid iounlink cr
;

hcProgPin pinhi hcProgPin pinout

\\ sometimes Teraterm hangs here until you press enter key

c" AT+VERSION~h0D~h0A" hcSend
c" AT+ROLE?~h0D~h0A" hcSend
c" AT+UART?~h0D~h0A" hcSend
c" AT+NAME?~h0D~h0A" hcSend
c" AT+PSWD?~h0D~h0A" hcSend


             \ make sure these display 'OK' 
             \ otherwise it isnt working, powercycle to fix
10000 delms \ 10 seconds to read the screen


c" AT+NAME=LittleRobot20130413~h0D~h0A" hcSend
c" AT+PSWD=1234~h0D~h0A" hcSend
c" AT+UART=230400,0,0~h0D~h0A" hcSend
c" AT+VERSION~h0D~h0A" hcSend
c" AT+ROLE?~h0D~h0A" hcSend
c" AT+UART?~h0D~h0A" hcSend
c" AT+NAME?~h0D~h0A" hcSend
c" AT+PSWD?~h0D~h0A" hcSend

hcProgPin pinlo 

\ after the hc05 is power cycled, the baud rate will change, not like the hc06

\ REMEMBER! HC05 Rx goes to PROP Tx
\ REMEMBER! HC05 Tx goes to PROP Rx

\ they have to criss-cross, the talker from one goes to the listener from the other


}}}

= Modify the DEVKERNEL.SPIN for Serial Pins 26 & 27 =

To use the HC05 as cable replacement:

After you have run the above script in propforth, and gotten the OK response for each configuration command, the HC05 is ready for use.

BUT you must also change the PROPFROTH KERNEL!

By default, propforth talks on pins 30 and 31.  

we have to change the spin file that creates the kernel to use pins 26 and 27 that connect to the HC05

In the proforth spin ource file

{{{
PropForthDevFastSerialKernel.spin
}}}

Edit lines 116 and 117:

{{{
  dlrS_txpin = 26 ' 30           ' $S_txpin forth word 
  dlrS_rxpin=  27 ' 31            ' $S_rxpin forth word 
}}}

Save the file as PropforthBluetooth.spin

Load it onto the prop EEPROM

The USB serial will no longer connect to propforth until the prop is reloaded with a standard kernel. 

Propforth will come up looking for the virtual Bluetooth com port.

= NOTES =

== Note: 20130413 ==

Fixed this page; previously the settings labeled HC05 were incorrect.  Those should have been labeled HC06.  Now, the page contains separate (correct) instructions for both.

== NOTE ==

The HC05 and HC06 modules look identical, I can't see any difference. They might be the same physical module with only the MODE set differently internally, but I did not check.  Did anyone use the HC06 settings on HC05 and have success?  I think  I may have, but my notes are incomplete. 

= NOTICE NOTICE NOTICE =

To use the HC05 as cable replacement:

See the note at the bottom of this page!


= Details =

Add your content here.  Format your content with:
  * Text in *bold* or _italic_
  * Headings, paragraphs, and lists
  * Automatic links to other wiki pages