#summary HC05 and HC06 Bluetooth for Little Robot(tm)
#labels HC06,LittleRobot,bluetooth,v5.5

<wiki:toc max_depth="9" />

= Introduction =

The HC05 and HC06  Bluetooth module allows communication with the prop via bluetooth.  No cables are needed after initial programming. 

This pages covers the immediate set up steps for the HC06.  If you have problems, or want to use the hc05, see

http://code.google.com/p/propforth/wiki/LittleRobotBluetoothDETAILS

for addditional details.

= HC06 =

The workshop is using the HC06 modules mounted on a 6 pin carrier board.  only Vcc (3.3v), GND, Rxd and Txd are used.

== Hardware connections ==

Connect Vcc to 3.3volts.  This is different from all the other parts, the connection is for HC06 Vcc goes to 3.3 on the quickstart. 

Connect GND to Vss as normal.

Connect HC06 - Tx tp pin 26

Connect HC06 - Rx tp pin 27

Don't connect the (GREEN wire) KEY to P1 yet.  We only do this if the HC06 is stubborn.

==  Power On ==

When you apply power, the RED LIGHT on the HC06 should blink.  This means the HC06 is ready.

If the HC06 RED LED does NOT blink, pull the power wire for a second or two, and reconnect.  Sometimes they come up flashing every time, sometimes they only come up every other time.  This is fine for our situation. 

== Configuration Scripts ==

The following is a modification of the script found in bot.f

NOTICE this script is undergoing maintenance, and is subject to change.

The first part of the script can be loaded with fastload (fl). Should we put this in the auto boot.f? * No, don't do it with boot.f, this is a one time event. *

The rest has to be input manually (by cut and paste),when we get to the touchy part.

-----

=== load the default communication for 9600 ===

Start with the easy part:

{{{
fl

\ for the HC06

\ green wire - this is not used on the carrier mounted modules
1 wconstant hcProgPin 

\ white/orange wire - QSbot RXD to p27
27 wconstant hcRx

\ white/green wire - QSbot TXD to p26
26 wconstant hcTx

\  initally they come up at 9600,  switch this after we set it to 230400

 9600 4/ wconstant hcBaud
\ 230400 4/ wconstant hcBaud 

0 wconstant hcSerialCog

hcSerialCog cogreset 100 delms
c" hcRx hcTx hcBaud serial" hcSerialCog cogx 100 delms


: hcSend
        cogid hcSerialCog iolink .cstr 1000 delms cogid iounlink cr
;

hcProgPin pinhi hcProgPin pinout

\ REMEMBER the HC06 LED must be blinking!
\ If it isn't blinking, disconnect HC06 Gnd, and reconnect. It will blink
\ If it isn't blinking, disconnect HC06 Vcc, and reconnect. It will blink
}}}


The above gets loaded automatically by boot.f 
* NO, auto boot.f at this point just gets confusing. Do all this manually with cut and paste *

-----

=== Verify the device is communicating ===

This part we do manually.  Copy and paste each lf therse three lines, one at a time.

{{{
c" AT" hcSend

c" AT+VERSION" hcSend
}}}

NOTE:  This was an error: 'c" AT+NAME?" hcSend' as it changes the device name to '?'

This does NOT echo the name: 'c" AT+NAME" hcSend'

The way to see the name after it is set is via the bluetooth paring screen on the android device, only.

After the HC06 responds to 

 * c" AT" hcSend    with OK 
 * c" AT+VERSION" hcSend with  OKlinvorV1.8  
 * c" AT+NAMElittlerobotnewname" hcSend  with OKsetname

You are ready to configure. 

=== Set the device to a name of your choice ===

Copy the following into an editor and  set the name correctly.  I used *CPL-01-of-12* here as I have a bunch of these to do before the next workshop. 

Send the commands one at a time 

{{{
c" AT" hcSend
c" AT+VERSION" hcSend
c" AT+NAMEQSbot-CPL-01-of-12" hcSend
c" AT+PIN1234" hcSend
c" AT+PN" hcSend
}}}

The above should set the name of the device (that is displayed on the Android Bluetooth Device panel), and make the pin code / password to 1234

-----

=== Change the BAUD to 230400 LAST ===

After the device is all ready go to, we change the BAUD LAST

This will change the transmission rate from a fast 9600 default baud to the very fast 230400 baud. 

{{{
\ note baud change immediately on hc06!!!!!
\ don't do this until you've set everything else.
\ c" AT+BAUD9" hcSend
c" AT+BAUD9" hcSend
}}}

-----

=== Power cycle and 230400 communication ===

AFTER YOU CHANGE THE HC06 BAUD to 23040, power cycle the prop and HC06.

Pull the Vcc wire again, and reconnect, to get the RED programming LED to flash again. 

Check the the HC06 is in fact programmed to run and 230400 with the followwing:

{{{
fl

\ REMEMBER the HC06 LED must be blinking!
\ If it isn't , disconnect Gnd, and reconnect. It will blink

\ for the HC06

\ green wire - this is not used on the carrier mounted modules
1 wconstant hcProgPin 

\ white/orange wire - QSbot RXD to p27
27 wconstant hcRx

\ white/green wire - QSbot TXD to p26
26 wconstant hcTx

\  initally they come up at 9600,  switch this after we set it to 230400

\ 9600 4/ wconstant hcBaud
230400 4/ wconstant hcBaud  \ NOW we are 230400 !!!

0 wconstant hcSerialCog

hcSerialCog cogreset 100 delms
c" hcRx hcTx hcBaud serial" hcSerialCog cogx 100 delms


: hcSend
        cogid hcSerialCog iolink .cstr 1000 delms cogid iounlink cr
;

hcProgPin pinhi hcProgPin pinout


}}}


Notice that this is sets 230400 baud, otherswise its the same as before.

Do the same diagnositc queries as above 

{{{
c" AT" hcSend

c" AT+VERSION" hcSend
}}}

 * Both should respond with OK, and the HC06 is set. 

= Pair with an Bluetooth master device =

To pair with an Android or windows device:

 * the red LED must be blinking 
 * Scan for the HC06 using an android device pairing screen.  The new name should be displayed. 
 * Pair with the device.  It should be listed as PAIRED DEVICE.  The red LED will continue to blink (until you CONNECT via blueterm)

= Connect to the HC06 =

From your terminal program:
 * Tera term on windows over bluetooth
 * blueterm on Android
 * GREEN on android

Find Connect Device.  Select the HC06, it will display the name you set. The RED LED on the HC06 will flash, and stay on solid when the divice is connected. 

The terminal will not respond yet, we have to set up the auto boot.f scrip still. 

= Auto BOOT.F for HC06 testing =

Use the following autoboot script to check the bluetooth setup.

This is a trimmed version of the auto boot.f script.  It just switches the prop serial I/O pins to use the HC06 pins (26 & 27)

After power cycle or reboot, the prop serial  I/O pins will switch to the bluetooth pins.  You can connect via blueterm or GREEN.

REMEMBER:  YOU MUST copy this to your editor, and paste it from there.  It doesn't work it you copy from the browser and paste directly to the terminal.

{{{
fl

fswrite BTtest.f

\ green wire - this is not used on the carrier mounted modules
\ 1 wconstant hcProgPin 

\ white/orange wire - QSbot RXD to p27
27 wconstant hcRx

\ white/green wire - QSbot TXD to p26
26 wconstant hcTx

\  initally they come up at 9600,  switch this after we set it to 230400
\ 9600 4/ wconstant hcBaud
\ 230400 4/ wconstant hcBaud 
\ 0 wconstant hcSerialCog
\ hcSerialCog cogreset 100 delms
\ c" hcRx hcTx hcBaud serial" hcSerialCog cogx 100 delms
\ : hcSend cogid hcSerialCog iolink .cstr 1000 delms cogid iounlink cr ;

: onreset6
  fkey? and fkey? and or h1B <>
if
     $S_con iodis $S_con cogreset 100 delms
     c" hcRx hcTx 57600 serial" $S_con cogx 100 delms
     cogid >con
then
     c" onreset6" (forget)
;

...

fswrite boot.f

hA state orC! version W@ .cstr cr cr cr
: findEETOP
0
h100000 h8000
do
i t0 2 eereadpage
if
leave
else
i h7FFE + t0 3 eereadpage
if
leave
else
drop i h8000 +
then
then
h8000 +loop
;

c" boot.f - Finding top of eeprom, " .cstr findEETOP ' fstop 2+ alignl L! forget findEETOP c" Top of eeprom at: " .cstr fstop . cr
c" boot.f - Loading BTtest.f~h0D~h0D" .cstr hA state andnC!
fsload BTtest.f
c" boot.f - Loaded BTtest.f~h0D~h0D" .cstr hA state andnC!
c" boot.f - DONE PropForth Loaded~h0D~h0D" .cstr hA state andnC!

...



cr

}}}

== Verify the Bluetooth connection ==

After reboot or power cycle, the prop will switch the serial connection to the blue tooth I/O pins.

The terminal program on a connected device will dispay the regular propforth prompt. 

Type a propforth command like 'words' to show the connection is working. 


-----

= TROUBLE SHOOTING =

The HC06 RED LED MUST BE BLINKING to program the HC06 via the PC terminal scripts.  Disconnect and reconnect the HC06 Vcc to put the HC06 into blink mode

The HC06 RED LED MUST BE BLINKING to pair with the bluetooth device terminal program.  Disconnect and reconnect the HC06 Vcc to put the HC06 into blink mode

The HC06 RED LED MUST BE BLINKING to connect to the bluetooth device terminal program.  Disconnect and reconnect the HC06 Vcc to put the HC06 into blink mode

After the HC06 is PAIRED with your android device, the RED LED will continue to blinky

After the HC06 is connected to the android terminal program , the RED LED will stay lit continuously

If the auto boot.f command gives you trouble, press and hold the ESC key during boot.  This will skip the auto boot.f behavior.

To remove a bad copy of the boot.f script:

 * from the propforth command line:
 * type 'fsls' to list the current script files
 * type 'fsclear'  to remove the script name entry

To put in a fixed/modified script:

 * reload the script (copy and paste from your editor)
 * reboot

= NOTES =

== Data Sheet ==

There are several data sheets available.  They are all pretty much bad translations of the pretty bad chineese original. 

http://etang.co.uk/datasheet/hc06/Bluetooth_HC-06_datasheet%20by%20cn.pdf

http://www.wavesen.com/mysys/db_picture/news3/200951285105101.pdf

-----

-----

== old section ==

ignore this section, it was needed during editing and will be removed. 

-----

The following turn OFF the programming mode and resets the bluetooth prgramming and configuration cog that minds the HC06 pins (26 and 27)

{{{

hcProgPin pinlo 

1000 delms

hcSerialCog cogreset 100 delms

hcProgPin pinlo


}}}

-----

*CHECK - it maybe that the programming commands exectue, but won't "take" (won't be made permanent and saved) unless the KEY line (pin 1) is held high. *

* ALSO - it may be the athe KEY line must be held HIGH from POWER UP until the end of the configuration events;  rather than high for each command and lo between commands. IF this is the case, connect KEY to Vcc and execute the configuration commands*

-----

NOw, the device should be fully programmed with it correct name and set to 230400 baud.

It should no longer respond at 9600.

Remove the old files from EEprom using 
{{{

fsls

fsclear

fsls

}}}

Replace the auto boot .f using the the following, and try the query command as at 230400:

fghjfgjhfgjfgjhfgjhfgj

-----

== Pair the devices ==

The HC05 should be visible as a slave (pairable) device when re-powered

=== Windows XP ===

Run Blue Tooth Wizard 

The wizard should find a device, and display the name you provided in the the script. 

Enter your pin (as you assigned in the script, or 1234 if you left the default)

XP will add two COM ports, on incoming and one out going. 

The outgoing port is the one you will use with Teraterm.  The incoming port doesn't do anything, but has to be there. 

=== Android ===

  * Select Settings.  
  * Under (or near) WiFi find Bluetooth. 
  * select "Search for Devices" (upper right corner on Nexus)

You should see an eight(?) hex value address displayed very quickly. 

A short time later this will change to the name you assigned in the script.

Select this, and enter your pin you define in the script, or 1234 if you left the default.

==== Blueterm ====

You can now connect to this device using Blue term (the three dots in the lower right corner is the secret!)

= Auto Boot.f to Blue tooth =

At this point, the HC06 Bluetooth device has been configured and paired with your Android or windows device. 

Set the automatic boot.f script to switch to the bluetooth communication on reboot. 


{{{
fl

wswrite boot.f

}}}

reboot.  The device will auotmatically switch to bluetooth communications.

To stop the script from autobooting, hold the ESC and the the boot prcess will skip the boot process. 

- end -