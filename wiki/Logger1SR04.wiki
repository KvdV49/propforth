#summary Logger1Simple with SR04
#labels v5.5,SR04,Logger

= Introduction =

This demo adds SR04 to Logger1Simple

= Step 1 Logger1Simple =

Load the SD kernel, and simple logger package found in 

http://code.google.com/p/propforth/downloads/detail?name=Logger-2013-05-12.zip

on the downloads section accoding to the instructions on the 

Logger1Simple  page.

NOTE: By default, logger 1 simple uses 
  * cog 0 for TIME COUNTER
  * cog 3 for LOGGER

= Step 2 SR04 =

Add the SR04 ultrasonic range finder

If you want to position the display output, you can do some crude but effective screen placement using ANSI terminal codes as shown in LittleRobotDemoUltrasonic

As always, remember:
 * SR04 needs 10k ohm resistor between echo and pin 25 (prop input pin)
 * SR04 connects to Vin (5volts)

Loading the follwoing will write the SRR04-SD.f file to memory
 
{{{
\ SR04 for SD logging

fl                                                                                  fl

10 fwrite SR04-SD.f

1 wconstant build_sr04
[ifndef _sr04_trig
	d_24 wconstant _sr04_trig
]
[ifndef _sr04_echo
	d_25 wconstant _sr04_echo
]

variable _sr04_distance

: _sr04_measure
	c" MEASURE" cds W!
	4 state andnC!

	_sr04_trig pinlo _sr04_trig pinout
	_sr04_echo >m
	_sr04_trig >m
	begin
		dup _maskouthi dup dup drop _maskoutlo

		over dup dup dup

		waitpeq
		cnt COG@
		rot2

		waitpne
		cnt COG@ swap -
		d_170_000 clkfreq */


		_sr04_distance L!
		
		100 delms
	0 until
;

[ifdef sr04_test
: sr04_test
	begin
		_sr04_distance L@ . 
		fkey? nip
    
    100 delms
    
	until
;
]

\ c" _sr04_measure" 1 cogx

c" _sr04_measure" nfcog cogx


...




}}}

For testing, manually load the code at the end

{{{
: sr04_test
	begin
		_sr04_distance L@ . 
		fkey? nip
    
    100 delms
    
	until
;
}}}

and run the word 'sr04_test' to display the SRR04 distance on the terminal display

= Step 3 Update usrboot.f =

Change usrboot.f to include the line to load (and launch) the SR04 driver.  For clarity, I name this file 'usrboot-SD04.f' in the source directory on the PC. 

{{{
fl

mountsys

100 fwrite usrboot.f
version W@  .cstr cr

c" usrboot.f  -  initializing~h0D~h0D" .cstr

1 sd_mount

\
\ Begin config parameters
\
[ifndef timeZoneHours
-7 constant timeZoneHours
]
[ifndef timeZoneMinutes
0 constant timeZoneMinutes
]
[ifndef doubleTimerCog
0 wconstant doubleTimerCog
]
\
\ End config parameters
\


fload DoubleMath.f
fload time.f
fload SR04-SD.f

lockdict wvariable logBuffer 256 allot freedict
: logdata
	getLocalTime formatTime logBuffer ccopy
	c"  CNT REGISTER: " logBuffer cappend
	base W@ hex cnt COG@ <# #s #> logBuffer cappend base W!
	c"  timeStamp: " logBuffer cappend
	base W@ decimal timeStamp <# d#s #> logBuffer cappend base W!
	c"  unixTimeStamp: " logBuffer cappend
	base W@ decimal unixTimeStamp <# d#s #> logBuffer cappend base W!


	c" ~h0D" logBuffer cappend
	logBuffer
;



clkfreq constant logperiod
\ log very second
: logger
	4 state andnC!
	c" LOGGER" cds W!
	mountusr
	cnt COG@ clkfreq +
	begin
		logperiod waitcnt
		logdata C@++ c" log" 7 lock sd_append 7 unlock
		
	0 until 
;

: ClearLog
	mountusr
	7 lock 0 c" log" sd_trunc 7 unlock
;

c" logger" nfcog cogx

fread .sdcardinfo

c" usrboot.f  -  DONE~h0D~h0D" .cstr


...

}}}


= Details =

Add your content here.  Format your content with:
  * Text in *bold* or _italic_
  * Headings, paragraphs, and lists
  * Automatic links to other wiki pages