#summary Logger1Simple with SR04
#labels v5.5,SR04,Logger

<wiki:toc max_depth="9" />


= Introduction =

This demo adds SR04 to Logger1Simple
-----
= Step 1 - SD kernel  =

== Make the SD slot ==

I used the Spinneret standard pinout from http://code.google.com/p/propforth/wiki/SDsetupREVISITED#Spineret_%28standard%29_Pinout

Solder wires to the SD adapter.  

Connect it up per the instructions.

Put the new card in the slot.

== Load the kernel ==

From the PropForth download archive, location the SD kernel directory in the current release. 

`\My Documents\PropforthV5.5\CurrentRelease\PropForthSD`

Load the SD kernel `SDkernel.spin` using the proptool, as per normal.  

NOTE: the card will give you some error messages until you initiale it in the next step.  This is normal. 

== initialize the SD card ==

From the PropForth download archive, location the SD kernel directory in the current release. 

`\My Documents\PropforthV5.5\CurrentRelease\PropForthSD`

Load the SD initialization script sdfsInitScript.f

Simply paste this into the termianl emulator, and it does the work.  

-----

= Step 2 - Logger 1 Simple = 

Load simple logger package found in 

http://code.google.com/p/propforth/downloads/detail?name=Logger-2013-05-12.zip

on the downloads section according to the instructions on the 

Logger1Simple  page.

NOTE: By default, logger 1 simple uses 
  * cog 0 for TIME COUNTER
  * cog 3 for LOGGER

== Double Math f ==

DoubleMath.f is the same as the default Logger1Simple download.

Paste this into the terminal emulator program first.

Use mountusr,  ls, and fread DounbleMath.f to veify the source file is in SD.

== time f ==

Time.f is the same as the default Logger1Simple download.

In this file, we can modify line 51 to change the logging frequency.  When clkfreq is used as the logging frequency, a log file record is recorded once every second.  multiplying this by 10 records once every 10 seconds etc. 

Recall that the crystal's drift is corrected each time the time is read. In the default case, the drift is corrected every second. The drift correction is stated in term of tick per hour.  I think the drift needs to be correct once each hour at minimum, but I didn't check it.  I think the might be affected by how often the records are collected, and how big the records are. Spare, short records might need a different correction than lots of long records, even on the same board.  I think what really matters is consistent record size and logging frequency, and setting the correction case by case. 

== logger init  f ==

LoggerInit.f is a short script that creates a  50 meg file on the mountusr partition.  Recall each block is 512 bytes. 100_000 blocks is 51.2 meg.

This script MUST be run or the logge won't log anything.  It will run, but the data won't have anyplace to go. 

Use the following command to switch to the user partiion, list the directory (by default is has one file , log), and display the contents of the log.
 
{{{
mountusr 
ls 
fread log
}}}

== SR04SD f ==

SR04-SD.f sets up the SR04 driver.  It uses the same pinout as the QSbot.f program discussed in the LittleRobot demo. 

When the program loads at boot time, it automatically starts the MEASURE routine on the next free cog. 

use `cog?` to show which tasks are running on each cog. 

== Logger Boot 10 hc06 f ==

Logger boot10-HC06.f is a modified LoggerBoot.f

This loads itself onto the SD card, and create the new usrboot.f file. 

The new userboot.f file is loaded automatically at boot time. 

It set the timezone, and sets the drift correction (whoops! I didn't put that in.  It goes AFTER the fload time.f; but I haven't figured the coreection for this test rig anyway).

It loads the drivers, and starts all the tasks.

IF you HOLD DOWN the ESC key while its booting, the boot will be aborted. 

IF you wait uuntil the scripts start loading THEN hold down the escape key, you can load all the driver, but prevent it from switching to blue tooh at the very end.  HANDY during DEBUG.

{{{
fl

mountsys

100 fwrite usrboot.f
version W@  .cstr cr

c" usrboot.f  -  initializing~h0D~h0D" .cstr

1 sd_mount

\
\ Begin config parameters
\
[ifndef timeZoneHours
-7 constant timeZoneHours
]
[ifndef timeZoneMinutes
0 constant timeZoneMinutes
]

\ from time.f
[ifndef doubleTimerCog
0 wconstant doubleTimerCog
]
\
\ End config parameters
\


fload DoubleMath.f
fload time.f

fload SR04SD.f


lockdict wvariable logBuffer 256 allot freedict
: logdata
	getLocalTime formatTime logBuffer ccopy
	c"  CNT REGISTER: " logBuffer cappend
	base W@ hex cnt COG@ <# #s #> logBuffer cappend base W!
\	c"  timeStamp: " logBuffer cappend
\	base W@ decimal timeStamp <# d#s #> logBuffer cappend base W!
\	c"  unixTimeStamp: " logBuffer cappend
\	base W@ decimal unixTimeStamp <# d#s #> logBuffer cappend base W!

	c"  SR04 mm: " logBuffer cappend
	base W@ decimal _sr04_distance L@ <# #s #> logBuffer cappend base W!

	c" ~h0D" logBuffer cappend
	logBuffer
;



\ clkfreq constant logperiod \ once each second
 clkfreq 10 * constant logperiod \ once each ten seconds

\ log very second
: logger
	4 state andnC!
	c" LOGGER" cds W!
	mountusr
	cnt COG@ clkfreq +
	begin
		logperiod waitcnt
		logdata C@++ c" log" 7 lock sd_append 7 unlock
		
	0 until 
;

: ClearLog
	mountusr
	7 lock 0 c" log" sd_trunc 7 unlock
;

\ =========
\ for the HC06
\ white/orange wire - QSbot RXD to p27
27 wconstant hcRx

\ white/green wire - QSbot TXD to p26
26 wconstant hcTx
\ 9600 4/ wconstant hcBaud
230400 4/ wconstant hcBaud  \ NOW we are 230400 !!!

nfcog wconstant hcSerialCog
\ hcSerialCog cogreset 100 delms
\  c" hcRx hcTx hcBaud serial " hcSerialCog cogx 100 delms
\ ==========


c" logger" nfcog cogx

fread .sdcardinfo

c" usrboot.f  -  DONE~h0D~h0D" .cstr

: onreset6
fkey? and fkey? and or h1B <>
if
$S_con iodis $S_con cogreset 100 delms
c" hcRx hcTx hcBaud serial" $S_con cogx 100 delms
cogid >con
\ c" _sr04_measure" 2 cogx
then
c" onreset6" (forget)
;
...

}}}

-----

= Step 3 SR04 =

Add the SR04 ultrasonic range finder

If you want to position the display output, you can do some crude but effective screen placement using ANSI terminal codes as shown in LittleRobotDemoUltrasonic

As always, remember:
 * SR04 needs 10k ohm resistor between echo and pin 25 (prop input pin)
 * SR04 connects to Vin (5volts)

Loading the follwoing will write the SRR04-SD.f file to memory
 
{{{
\ SR04 for SD logging

fl                                                                                  fl

10 fwrite SR04-SD.f

1 wconstant build_sr04
[ifndef _sr04_trig
	d_24 wconstant _sr04_trig
]
[ifndef _sr04_echo
	d_25 wconstant _sr04_echo
]

variable _sr04_distance

: _sr04_measure
	c" MEASURE" cds W!
	4 state andnC!

	_sr04_trig pinlo _sr04_trig pinout
	_sr04_echo >m
	_sr04_trig >m
	begin
		dup _maskouthi dup dup drop _maskoutlo

		over dup dup dup

		waitpeq
		cnt COG@
		rot2

		waitpne
		cnt COG@ swap -
		d_170_000 clkfreq */


		_sr04_distance L!
		
		100 delms
	0 until
;

[ifdef sr04_test
: sr04_test
	begin
		_sr04_distance L@ . 
		fkey? nip
    
    100 delms
    
	until
;
]

\ c" _sr04_measure" 1 cogx

c" _sr04_measure" nfcog cogx


...




}}}

For testing, manually load the code at the end

{{{
: sr04_test
	begin
		_sr04_distance L@ . 
		fkey? nip
    
    100 delms
    
	until
;
}}}

and run the word 'sr04_test' to display the SRR04 distance on the terminal display

-----
= Step 4 Update usrboot.f =

Change usrboot.f to include the line to load (and launch) the SR04 driver.  For clarity, I name this file 'usrboot-SD04.f' in the source directory on the PC. 

{{{
fl

mountsys

100 fwrite usrboot.f
version W@  .cstr cr

c" usrboot.f  -  initializing~h0D~h0D" .cstr

1 sd_mount

\
\ Begin config parameters
\
[ifndef timeZoneHours
-7 constant timeZoneHours
]
[ifndef timeZoneMinutes
0 constant timeZoneMinutes
]
[ifndef doubleTimerCog
0 wconstant doubleTimerCog
]
\
\ End config parameters
\


fload DoubleMath.f
fload time.f
fload SR04-SD.f

lockdict wvariable logBuffer 256 allot freedict
: logdata
	getLocalTime formatTime logBuffer ccopy
	c"  CNT REGISTER: " logBuffer cappend
	base W@ hex cnt COG@ <# #s #> logBuffer cappend base W!
	c"  timeStamp: " logBuffer cappend
	base W@ decimal timeStamp <# d#s #> logBuffer cappend base W!
	c"  unixTimeStamp: " logBuffer cappend
	base W@ decimal unixTimeStamp <# d#s #> logBuffer cappend base W!


	c" ~h0D" logBuffer cappend
	logBuffer
;



clkfreq constant logperiod
\ log very second
: logger
	4 state andnC!
	c" LOGGER" cds W!
	mountusr
	cnt COG@ clkfreq +
	begin
		logperiod waitcnt
		logdata C@++ c" log" 7 lock sd_append 7 unlock
		
	0 until 
;

: ClearLog
	mountusr
	7 lock 0 c" log" sd_trunc 7 unlock
;

c" logger" nfcog cogx

fread .sdcardinfo

c" usrboot.f  -  DONE~h0D~h0D" .cstr


...

}}}

On powercycle or reboot, run the 'cog?' command to see that ach dirver is running:

{{{
Prop0 Cog6 ok
cog?
Cog:0  #io chan:1                     TIME COUNTER
Cog:1  #io chan:1 PropForth v5.5 2013Feb20 11:30 0
Cog:2  #io chan:1                          MEASURE
Cog:3  #io chan:1                           LOGGER
Cog:4  #io chan:1 PropForth v5.5 2013Feb20 11:30 0
Cog:5  #io chan:1 PropForth v5.5 2013Feb20 11:30 0
Cog:6  #io chan:1 PropForth v5.5 2013Feb20 11:30 0  6(0)->7(0)
Cog:7  #io chan:1                           SERIAL  7(0)->6(0)
Prop0 Cog6 ok


}}}
-----
= Step 5 - Log the SR04 data =

After the logger and the SR04 are working, change the logger routing to log the SR04.  Add the appropriate line to the 'logdata' word as shown below, and paste the new 'LoggerBoot-SR04.f' file into the terminal.  Reboot.

Use 'ClearLog' to erase the old data from the log file.   Be sure to 'mountusr' to switch to the user partition on the SD, that is where the 'log' file resides.

{{{
fl

mountsys

100 fwrite usrboot.f
version W@  .cstr cr

c" usrboot.f  -  initializing~h0D~h0D" .cstr

1 sd_mount

\
\ Begin config parameters
\
[ifndef timeZoneHours
-7 constant timeZoneHours
]
[ifndef timeZoneMinutes
0 constant timeZoneMinutes
]
[ifndef doubleTimerCog
0 wconstant doubleTimerCog
]
\
\ End config parameters
\


fload DoubleMath.f
fload time.f
fload SR04-SD.f

lockdict wvariable logBuffer 256 allot freedict
: logdata
	getLocalTime formatTime logBuffer ccopy
	c"  CNT REGISTER: " logBuffer cappend
	base W@ hex cnt COG@ <# #s #> logBuffer cappend base W!
	c"  timeStamp: " logBuffer cappend
	base W@ decimal timeStamp <# d#s #> logBuffer cappend base W!
	c"  unixTimeStamp: " logBuffer cappend
	base W@ decimal unixTimeStamp <# d#s #> logBuffer cappend base W!
  
 c"  SR04 mm: "      logBuffer cappend
 base W@ decimal _sr04_distance  L@ <# #s #> logBuffer cappend base W!

	c" ~h0D" logBuffer cappend
	logBuffer
;



\ clkfreq constant logperiod  \ log everry second
clkfreq 10 * constant logperiod  \ log every 10 second

\ log very second
: logger
	4 state andnC!
	c" LOGGER" cds W!
	mountusr
	cnt COG@ clkfreq +
	begin
		logperiod waitcnt
		logdata C@++ c" log" 7 lock sd_append 7 unlock
		
	0 until 
;

: ClearLog
	mountusr
	7 lock 0 c" log" sd_trunc 7 unlock
;

c" logger" nfcog cogx

fread .sdcardinfo

c" usrboot.f  -  DONE~h0D~h0D" .cstr


...

}}}

-----

= Step 6 - Connect via Blue tooth =

If you wish to connect wirelessly via blue tooth, it is advisable to do this last. 

After the SD kernel is shown to be working; and the logger is working, and the dirft offset has been calibrated, and the SR04 is working, and the SRR04 is logging, add blue tooth suupport using the HC06.

First paste 'BTtest-SD.f' , this is the regular BTtest.f modified for SD.

{{{

\ HC06 - final code auto boot switches to bluetooh comms

fl

mountsys

100 fwrite BTtest.f

\ green wire - this is not used on the carrier mounted modules
\ 1 wconstant hcProgPin 

\ white/orange wire - QSbot RXD to p27
27 wconstant hcRx

\ white/green wire - QSbot TXD to p26
26 wconstant hcTx

\  initally they come up at 9600,  switch this after we set it to 230400
\ 9600 4/ wconstant hcBaud
\ 230400 4/ wconstant hcBaud 
\ 0 wconstant hcSerialCog
\ hcSerialCog cogreset 100 delms
\ c" hcRx hcTx hcBaud serial" hcSerialCog cogx 100 delms
\ : hcSend cogid hcSerialCog iolink .cstr 1000 delms cogid iounlink cr ;

: onreset6
  fkey? and fkey? and or h1B <>
if
     $S_con iodis $S_con cogreset 100 delms
     c" hcRx hcTx 57600 serial" $S_con cogx 100 delms
     cogid >con
then
     c" onreset6" (forget)
;

...


}}}

Then past the final version of 'LoggerBoot-SR04.f' to switch the serial lines to the HC06. 

{{{
fl

\ mountsys

 100 fwrite usrboot.f

\ fswrite boot.f

version W@  .cstr cr

c" usrboot.f  -  initializing~h0D~h0D" .cstr

\ 1 sd_mount

\
\ Begin config parameters
\
[ifndef timeZoneHours
-7 constant timeZoneHours
]
[ifndef timeZoneMinutes
0 constant timeZoneMinutes
]
[ifndef doubleTimerCog
0 wconstant doubleTimerCog
]
\
\ End config parameters
\

fload DoubleMath.f
fload time.f
fload SR04-SD.f
fload BTtest.f

lockdict wvariable logBuffer 256 allot freedict
: logdata
        getLocalTime formatTime logBuffer ccopy
        c"  CNT REGISTER: " logBuffer cappend
        base W@ hex cnt COG@ <# #s #> logBuffer cappend base W!
        c"  timeStamp: " logBuffer cappend
        base W@ decimal timeStamp <# d#s #> logBuffer cappend base W!
        c"  unixTimeStamp: " logBuffer cappend
        base W@ decimal unixTimeStamp <# d#s #> logBuffer cappend base W!
  
 c"  SR04 mm: "      logBuffer cappend
 base W@ decimal _sr04_distance  L@ <# #s #> logBuffer cappend base W!

        c" ~h0D" logBuffer cappend
        logBuffer
;



\ clkfreq constant logperiod  \ log everry second
clkfreq 10 * constant logperiod  \ log every 10 second

\ log very second
: logger
        4 state andnC!
        c" LOGGER" cds W!
        mountusr
        cnt COG@ clkfreq +
        begin
                logperiod waitcnt
                logdata C@++ c" log" 7 lock sd_append 7 unlock
                
        0 until 
;

: ClearLog
        mountusr
        7 lock 0 c" log" sd_trunc 7 unlock
;

c" logger" nfcog cogx

fread .sdcardinfo

[ifdef setDriftCorrection
34320 setDriftCorrection  \ for20130901 DPPL01  
\ 0 setDriftCorrection 
]

cr cr c" setDriftCorrection is " .cstr _driftCorrectionNumerator dL@ du.

c" usrboot.f  -  DONE~h0D~h0D" .cstr

...

cr

}}}

-----

= Details =

Add your content here.  Format your content with:
  * Text in *bold* or _italic_
  * Headings, paragraphs, and lists
  * Automatic links to other wiki pages